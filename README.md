## Toward Resource-Efficient Packet Header Vector Encoding on Programmable Switches

The programmable switch offers a limited capacity of packet header vector (PHV) words that store packet header fields and metadata fields defined by network functions. However, existing switch compilers employ inefficient strategies of encoding fields on PHV words. Their encoding wastes scarce PHV words and may result in failures when deploying network functions. In this paper, we propose Melody, a new framework that reuses PHV words for as many fields as possible to achieve resource-efficient PHV encoding. Melody offers a field analyzer and an optimization framework. The analyzer identifies which fields can reuse PHV words while preserving the original packet processing logic. The framework integrates analysis results into its encoding to offer the resource-optimal decisions. 

This work has been accepted by IEEE INFOCOM 2023. This is a joint work by Zhejiang University, Peking University, Fuzhou University, Yangzhou University, and Southeast University. This repo provides the source code of Melody that targets BMv2 software switches. 

The name, Melody, refers to [the famous song written by David Zee Tao](https://www.youtube.com/watch?v=yEtU5tzZMkY&ab_channel=TimelessMusic). 

## Overview 

The code has three parts: preprocessor, analyzer, and optimizer/heuristic. 

- **preprocessor** transforms the input data plane program in P4 into intermediate files.
- **analyzer**
   - It contains two C++ programs, parser.cpp and analyzer.cpp. Those programs read and parse intermediate files generated by the preprocessor. Also, they extract fields, lengths, as well as MAT execution dependencies and mutual exclusions from parsing results.
   - phv.txt describes the capacity of PHV words in the target switch architecture (e.g., Tofino). 
- **optimizer** includes two C++ programs, optimizer.cpp and heuristic.cpp, which respectively represent the two algorithms mentioned by the paper, MIP and heuristic.
- **melody.cpp** is the main program of Melody. 
- **run.sh** is the startup script of Melody. Users run this script with the paths pointing to a P4 program and phv.txt to activate Melody. 
- **libgurobi110.so** is the dynamic link library required for guanxi program running 

Input: 
- P4 program: example.p4
- Switch PHV Capacity: phv.txt

Output: 
- **heuristic_res.txt** and **ilp_res.txt**: the results of MIP and heuristic algorithms. 
- **output.txt**: the logs of Melody execution.

